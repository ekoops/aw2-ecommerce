version: "3.9"

services:
  order-svc:
    image: aw2-ecommerce/order-svc
    container_name: order-svc
    build:
      dockerfile: ../order-service/Dockerfile # relative to the build context
      context: ../order-service/build
    #    restart: always
    env_file:
      - configs/order-svc.env.prod
    ports:
      - "3000:3000"
    networks:
      - order-net
      - communication-net
    depends_on:
      - order-db-initer
      - kafka
  #      - discovery-svc

  # order-svc-cleaner:
  #   image: aw2-ecommerce/order-svc-cleaner
  #   container_name: order-svc-cleaner
  #   build:
  #     dockerfile: ../Dockerfile # relative to the build context
  #     context: ./order-service-cleaner/build
  #   #    restart: always
  #   env_file:
  #     - configs/order-svc-cleaner.env.prod
  #   ports:
  #     - "3000:3000"
  #   networks:
  #     - order-net
  #   depends_on:
  #     - order-db

  order-db-initer:
    image: aw2-ecommerce/order-db-initer
    container_name: order-db-initer
    build:
      dockerfile: ../Dockerfile # relative to the build context
      context: ../order-db-initer
    #    restart: always
    env_file:
      - configs/order-db-initer.env.prod
    networks:
      - order-net
    depends_on:
      - order-db-rs0-1
      - order-db-rs0-2
      - order-db-rs0-3

  order-db-rs0-1:
    image: "mongo:5.0.2"
    container_name: order-db-rs0-1
    #    restart: always
    env_file:
      - configs/order-db.env.prod
    #    ports:
    #      - "27017:27017"
    volumes:
      - order-db-rs0-1-data:/data/db
    command: --replSet rs0 --oplogSize 1024
    networks:
      - order-net
      - kafka-net
    depends_on:
      - order-db-rs0-2
      - order-db-rs0-3
    logging:
      driver: none

  order-db-rs0-2:
    image: "mongo:5.0.2"
    container_name: order-db-rs0-2
    #    restart: always
    env_file:
      - configs/order-db.env.prod
    #    ports:
    #      - "27018:27017"
    volumes:
      - order-db-rs0-2-data:/data/db
    command: --replSet rs0 --oplogSize 128
    networks:
      - order-net
      - kafka-net
    logging:
      driver: none

  order-db-rs0-3:
    image: "mongo:5.0.2"
    container_name: order-db-rs0-3
    #    restart: always
    env_file:
      - configs/order-db.env.prod
    #    ports:
    #      - "27019:27017"
    volumes:
      - order-db-rs0-3-data:/data/db
    command: --replSet rs0 --oplogSize 128
    networks:
      - order-net
      - kafka-net
    logging:
      driver: none
